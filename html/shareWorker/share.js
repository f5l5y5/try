/*
 * ========================================================================
 * SharedWorker 跨页面通信设计思路与流程图
 * ========================================================================
 *
 * 一、整体架构
 * ┌─────────────────────────────────────────────────────────────────┐
 * │                     SharedWorker 通信架构                          │
 * ├─────────────────────────────────────────────────────────────────┤
 * │                                                                   │
 * │  页面 A (page-123)                页面 B (page-456)               │
 * │       │                                  │                        │
 * │       │ new SharedWorker()               │ new SharedWorker()    │
 * │       │                                  │                        │
 * │       ▼                                  ▼                        │
 * │  ┌─────────┐                        ┌─────────┐                  │
 * │  │ port A  │                        │ port B  │                  │
 * │  └────┬────┘                        └────┬────┘                  │
 * │       │                                  │                        │
 * │       │ MessagePort                      │ MessagePort            │
 * │       │                                  │                        │
 * │       └──────────────┬───────────────────┘                        │
 * │                      │                                            │
 * │                      ▼                                            │
 * │          ┌──────────────────────────┐                            │
 * │          │   SharedWorker 实例       │                            │
 * │          │  (share.js 单例)          │                            │
 * │          │                            │                            │
 * │          │  connections Map:          │                            │
 * │          │  ├─ 'page-123' → port A   │                            │
 * │          │  └─ 'page-456' → port B   │                            │
 * │          └──────────────────────────┘                            │
 * │                                                                   │
 * └─────────────────────────────────────────────────────────────────┘
 *
 * 二、连接建立流程
 * ┌─────────────────────────────────────────────────────────────────┐
 * │                     页面连接到 Worker 流程                         │
 * ├─────────────────────────────────────────────────────────────────┤
 * │                                                                   │
 * │  页面端                            Worker 端                      │
 * │  ═════                            ════════                       │
 * │                                                                   │
 * │  1. 创建实例                                                       │
 * │  ┌───────────────────┐                                           │
 * │  │ new SharedWorker  │                                           │
 * │  │  ('./share.js')   │                                           │
 * │  └────────┬──────────┘                                           │
 * │           │                                                       │
 * │           ▼                                                       │
 * │  2. 获取端口                       触发 'connect' 事件             │
 * │  ┌───────────────────┐            ┌─────────────────┐           │
 * │  │ port = worker.port│───────────▶│ e.ports[0]      │           │
 * │  └────────┬──────────┘            └────────┬────────┘           │
 * │           │                                │                     │
 * │           ▼                                ▼                     │
 * │  3. 启动端口                       启动端口                       │
 * │  ┌───────────────────┐            ┌─────────────────┐           │
 * │  │ port.start()      │            │ port.start()    │           │
 * │  └────────┬──────────┘            └────────┬────────┘           │
 * │           │                                │                     │
 * │           ▼                                ▼                     │
 * │  4. 注册监听器                     注册监听器                     │
 * │  ┌───────────────────┐            ┌─────────────────┐           │
 * │  │ port.onmessage =  │            │ port.onmessage  │           │
 * │  │   (msg) => {...}  │            │   = (msg) => {} │           │
 * │  └────────┬──────────┘            └────────┬────────┘           │
 * │           │                                │                     │
 * │           ▼                                │                     │
 * │  5. 发送注册消息                           │                     │
 * │  ┌───────────────────┐                    │                     │
 * │  │ postMessage({     │                    │                     │
 * │  │   type: 'register'│────────────────────┘                     │
 * │  │   pageId: 'xxx'   │            ▼                             │
 * │  │ })                │     保存到 connections Map               │
 * │  └───────────────────┘     ┌─────────────────┐                 │
 * │                             │ connections.set │                 │
 * │                             │  (pageId, port) │                 │
 * │                             └─────────────────┘                 │
 * │                                                                   │
 * └─────────────────────────────────────────────────────────────────┘
 *
 * 三、消息处理流程
 * ┌─────────────────────────────────────────────────────────────────┐
 * │                        消息类型处理流程                            │
 * ├─────────────────────────────────────────────────────────────────┤
 * │                                                                   │
 * │  收到消息                                                          │
 * │     │                                                             │
 * │     ▼                                                             │
 * │  解析消息                                                          │
 * │  { type, pageId, target, data }                                 │
 * │     │                                                             │
 * │     ├─────────┬─────────────┬──────────────┐                    │
 * │     ▼         ▼             ▼              ▼                    │
 * │  register  broadcast     private       其他...                   │
 * │     │         │             │                                    │
 * │     ▼         ▼             ▼                                    │
 * │  ┌──────┐ ┌────────────┐ ┌──────────────┐                      │
 * │  │ 注册 │ │ 遍历所有端口│ │ 查找目标端口  │                      │
 * │  │ 页面 │ │ forEach     │ │ connections. │                      │
 * │  │      │ │ conn =>     │ │ has(target)  │                      │
 * │  │保存到│ │ postMessage │ │    ▼         │                      │
 * │  │ Map  │ │             │ │ 找到 ─→ 发送 │                      │
 * │  └──────┘ └────────────┘ │ 未找到 ─→警告│                      │
 * │                           └──────────────┘                      │
 * │                                                                   │
 * └─────────────────────────────────────────────────────────────────┘
 *
 * 四、广播消息流程详解
 * ┌─────────────────────────────────────────────────────────────────┐
 * │  页面 A 发送广播                                                   │
 * │  ┌─────────────────┐                                             │
 * │  │ postMessage({   │                                             │
 * │  │  type:'broadcast│                                             │
 * │  │  data:'Hello'   │                                             │
 * │  │ })              │                                             │
 * │  └────────┬────────┘                                             │
 * │           │                                                       │
 * │           ▼                                                       │
 * │      Worker 收到消息                                              │
 * │      ┌──────────────┐                                            │
 * │      │ type ==='    │                                            │
 * │      │  broadcast'? │──── Yes                                    │
 * │      └──────────────┘       │                                    │
 * │                             ▼                                    │
 * │                    遍历 connections Map                          │
 * │                    ┌─────────────────────┐                      │
 * │                    │ forEach((conn, id)  │                      │
 * │                    │   conn.postMessage  │                      │
 * │                    │ )                   │                      │
 * │                    └──────┬──────────────┘                      │
 * │                           │                                      │
 * │           ┌───────────────┼───────────────┐                     │
 * │           ▼               ▼               ▼                     │
 * │     ┌─────────┐     ┌─────────┐     ┌─────────┐               │
 * │     │ 页面 A  │     │ 页面 B  │     │ 页面 C  │               │
 * │     │收到消息 │     │收到消息 │     │收到消息 │               │
 * │     └─────────┘     └─────────┘     └─────────┘               │
 * │                                                                   │
 * └─────────────────────────────────────────────────────────────────┘
 *
 * 五、点对点消息流程详解
 * ┌─────────────────────────────────────────────────────────────────┐
 * │  页面 A 发送私信给页面 B                                           │
 * │  ┌─────────────────┐                                             │
 * │  │ postMessage({   │                                             │
 * │  │  type:'private' │                                             │
 * │  │  target:'page-B'│                                             │
 * │  │  data:'Hi B'    │                                             │
 * │  │ })              │                                             │
 * │  └────────┬────────┘                                             │
 * │           │                                                       │
 * │           ▼                                                       │
 * │      Worker 收到消息                                              │
 * │      ┌──────────────────┐                                        │
 * │      │ connections.has  │                                        │
 * │      │   (target)?      │                                        │
 * │      └────┬─────────┬───┘                                        │
 * │           │ Yes     │ No                                         │
 * │           ▼         ▼                                            │
 * │    ┌──────────┐ ┌──────────┐                                    │
 * │    │ 获取目标 │ │ 输出警告 │                                    │
 * │    │ port     │ │ 未找到   │                                    │
 * │    │          │ └──────────┘                                    │
 * │    │postMessage                                                  │
 * │    └────┬─────┘                                                  │
 * │         │                                                         │
 * │         ▼                                                         │
 * │   ┌─────────┐                                                    │
 * │   │ 页面 B  │                                                    │
 * │   │收到消息 │                                                    │
 * │   └─────────┘                                                    │
 * │                                                                   │
 * │   页面 A、C、D 不会收到此消息                                     │
 * │                                                                   │
 * └─────────────────────────────────────────────────────────────────┘
 *
 * 六、数据结构设计
 * ┌─────────────────────────────────────────────────────────────────┐
 * │  connections: Map<string, MessagePort>                          │
 * │  ─────────────────────────────────────────                      │
 * │                                                                   │
 * │  为什么用 Map 而不是 Set？                                        │
 * │  ════════════════════════                                        │
 * │                                                                   │
 * │  ❌ Set 的问题：                                                  │
 * │     页面刷新 → 创建新的 port 对象                                 │
 * │     Set 通过对象引用判断唯一性                                    │
 * │     无法识别是同一个页面的新连接                                  │
 * │     ┌─────────────────────────────┐                             │
 * │     │ Set: [portA1, portA2, portB]│  ← 页面 A 刷新后有2个端口   │
 * │     └─────────────────────────────┘                             │
 * │                                                                   │
 * │  ✅ Map 的优势：                                                  │
 * │     使用 pageId (字符串) 作为 key                                │
 * │     页面刷新时会自动覆盖旧连接                                    │
 * │     ┌──────────────────────────────┐                            │
 * │     │ Map: {                        │                            │
 * │     │   'page-123' → portA,         │  ← 页面 A 只有1个端口     │
 * │     │   'page-456' → portB          │                            │
 * │     │ }                             │                            │
 * │     └──────────────────────────────┘                            │
 * │                                                                   │
 * │  结构示例：                                                       │
 * │  ┌───────────┬──────────────────────────────┐                   │
 * │  │    Key    │           Value              │                   │
 * │  ├───────────┼──────────────────────────────┤                   │
 * │  │ 'page-123'│ MessagePort {                │                   │
 * │  │           │   pageId: 'page-123',        │                   │
 * │  │           │   postMessage: function,     │                   │
 * │  │           │   close: function            │                   │
 * │  │           │ }                            │                   │
 * │  ├───────────┼──────────────────────────────┤                   │
 * │  │ 'page-456'│ MessagePort {                │                   │
 * │  │           │   pageId: 'page-456',        │                   │
 * │  │           │   ...                        │                   │
 * │  │           │ }                            │                   │
 * │  └───────────┴──────────────────────────────┘                   │
 * │                                                                   │
 * └─────────────────────────────────────────────────────────────────┘
 *
 * 七、使用示例
 * ┌─────────────────────────────────────────────────────────────────┐
 * │  // 页面端代码                                                    │
 * │  const worker = new SharedWorker('./share.js');                 │
 * │  const port = worker.port;                                      │
 * │                                                                   │
 * │  port.start();  // 1. 启动端口                                   │
 * │                                                                   │
 * │  port.onmessage = (msg) => {  // 2. 监听消息                     │
 * │      console.log('收到:', msg.data);                             │
 * │  };                                                              │
 * │                                                                   │
 * │  port.postMessage({  // 3. 注册页面                              │
 * │      type: 'register',                                           │
 * │      pageId: 'page-123'                                          │
 * │  });                                                             │
 * │                                                                   │
 * │  port.postMessage({  // 4. 发送广播                              │
 * │      type: 'broadcast',                                          │
 * │      pageId: 'page-123',                                         │
 * │      data: 'Hello everyone!'                                     │
 * │  });                                                             │
 * │                                                                   │
 * │  port.postMessage({  // 5. 发送私信                              │
 * │      type: 'private',                                            │
 * │      pageId: 'page-123',                                         │
 * │      target: 'page-456',                                         │
 * │      data: 'Hi page-456!'                                        │
 * │  });                                                             │
 * └─────────────────────────────────────────────────────────────────┘
 *
 * 八、核心要点
 * ┌─────────────────────────────────────────────────────────────────┐
 * │  1. 必须通过 HTTP/HTTPS 访问（不能用 file:// 协议）               │
 * │  2. port.start() 必须在监听器之前调用                             │
 * │  3. 使用 onmessage 比 addEventListener 更可靠                    │
 * │  4. pageId 必须唯一且稳定（刷新后不变）                           │
 * │  5. 页面刷新时 Map 会自动覆盖旧连接                               │
 * │  6. 所有页面关闭后 SharedWorker 会自动终止                        │
 * │  7. 同源策略：只有同域名同端口的页面可以共享                       │
 * └─────────────────────────────────────────────────────────────────┘
 */

// 存储所有页面与Worker的连接端口（使用 Map，key 是 pageId，value 是 port）
const connections = new Map();

console.log('打印***self', self)
// 监听新页面的连接请求
self.addEventListener('connect', (e) => {
    console.log('打印***e', e, connections)
    // 获取当前页面的通讯端口
    const port = e.ports[0];

    // 注意：此时还不知道 pageId，需要等待 register 消息
    console.log(`新页面尝试连接，等待注册...`);

    // // 允许端口通讯（必须在注册监听器之前调用）
    // port.start();

    // // 向页面发送连接成功消息（用于调试）
    // port.postMessage({
    //     from: 'Worker',
    //     type: 'connected',
    //     data: `Worker 已连接，当前连接数：${connections.size}`
    // });

    // 监听端口的消息事件（接收页面发来的消息）
    port.onmessage = (msg) => {
        console.log('Worker收到消息:', msg.data);
        const { type, target, data, pageId } = msg.data;

        // 0. 处理注册消息（页面连接时立即发送）
        if (type === 'register') {
            // 如果该 pageId 已存在，说明是页面刷新，先关闭旧连接
            if (connections.has(pageId)) {
                const oldPort = connections.get(pageId);
                console.log(`页面 ${pageId} 刷新，清理旧连接`);
                try {
                    oldPort.close();
                } catch (e) {
                    // 忽略关闭错误
                }
            }

            // 保存新连接
            port.pageId = pageId;
            connections.set(pageId, port);
            console.log(`页面 ${pageId} 已注册，当前在线：[${Array.from(connections.keys()).join(', ')}]`);
            return;
        }

        // 保存页面标识到端口对象（兼容旧的发送方式）
        if (pageId && !port.pageId) {
            port.pageId = pageId;
            connections.set(pageId, port);
            console.log(`页面 ${pageId} 已注册（兼容模式）`);
        }

        // 1. 广播消息：发送给所有连接的页面
        if (type === 'broadcast') {
            console.log(`广播消息给 ${connections.size} 个连接`);
            connections.forEach((conn, id) => {
                try {
                    conn.postMessage({ from: 'Worker', data: `广播消息：${data}` });
                } catch (e) {
                    console.log(`发送给 ${id} 失败，移除连接`);
                    connections.delete(id);
                }
            });
        }
        // 2. 点对点消息：仅发送给目标页面（这里用页面标识区分）
        else if (type === 'private') {
            console.log(`私发消息给 ${target}，当前连接：[${Array.from(connections.keys()).join(', ')}]`);

            if (connections.has(target)) {
                try {
                    connections.get(target).postMessage({ from: 'Worker', data: `私发消息：${data}` });
                } catch (e) {
                    console.log(`发送给 ${target} 失败，移除连接`);
                    connections.delete(target);
                }
            } else {
                console.log(`警告：未找到目标页面 ${target}`);
            }
        }
    };

    // 监听端口关闭事件（页面关闭或主动断开）
    port.addEventListener('close', () => {
        // 通过 pageId 删除连接
        if (port.pageId) {
            connections.delete(port.pageId);
            console.log(`页面 ${port.pageId} 断开连接，当前在线：[${Array.from(connections.keys()).join(', ')}]`);
        }
    });

    // 允许端口通讯（必须调用，否则无法收发消息）
    port.start();
});