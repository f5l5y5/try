<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iframe 通讯测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .iframe-wrapper {
            flex: 1;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .parent-log {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border: 2px solid #4caf50;
            border-radius: 8px;
        }

        .parent-log h3 {
            margin-top: 0;
            color: #4caf50;
        }

        .log-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #f1f8e9;
            border-left: 3px solid #4caf50;
            border-radius: 4px;
        }

        .instructions {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }

        .parent-message-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ff9800;
        }

        .parent-message-box h3 {
            margin-top: 0;
            color: #ff9800;
        }

        .parent-message-box input {
            padding: 10px;
            width: 400px;
            border: 1px solid #ff9800;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 10px;
        }

        .parent-message-box button {
            padding: 10px 20px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }

        .parent-message-box button:hover {
            background-color: #f57c00;
        }
    </style>
</head>

<body>
    <h1>Iframe 通讯测试页面</h1>

    <div class="instructions">
        <h3>使用说明：</h3>
        <ul>
            <li>左侧是 Iframe 1，右侧是 Iframe 2</li>
            <li>可以在任意 iframe 中输入消息并发送给另一个 iframe 或父页面</li>
            <li>所有消息都通过父页面（当前页面）进行转发</li>
            <li>使用 postMessage API 实现跨 iframe 通讯</li>
        </ul>
    </div>

    <div class="parent-message-box">
        <h3>父页面发送消息 (postMessage)</h3>
        <div>
            <input type="text" id="parentMessageInput" placeholder="输入消息..." />
            <button onclick="sendMessageToIframe1()">发送到 Iframe 1 (Home)</button>
            <button onclick="sendMessageToIframe2()">发送到 Iframe 2 (About)</button>
            <button onclick="sendMessageToAll()">广播到所有 Iframe</button>
        </div>
    </div>

    <div class="parent-message-box" style="border-color: #e91e63; margin-top: 15px;">
        <h3 style="color: #e91e63;">MessageChannel 通信</h3>
        <div>
            <input type="text" id="channelMessageInput" placeholder="输入MessageChannel消息..." />
            <button onclick="sendChannelToIframe1()" style="background-color: #e91e63;">Channel发送到 Home</button>
            <button onclick="sendChannelToIframe2()" style="background-color: #e91e63;">Channel发送到 About</button>
            <button onclick="sendChannelToAll()" style="background-color: #e91e63;">Channel广播</button>
        </div>
    </div>

    <div class="parent-message-box" style="border-color: #9c27b0; margin-top: 15px;">
        <h3 style="color: #9c27b0;">兄弟通信 (父页面中转)</h3>
        <div>
            <input type="text" id="brotherMessageInput" placeholder="输入兄弟通信消息..." />
            <button onclick="sendBrotherFrom1To2()" style="background-color: #9c27b0;">Home → About</button>
            <button onclick="sendBrotherFrom2To1()" style="background-color: #9c27b0;">About → Home</button>
        </div>
    </div>

    <div class="container">
        <div class="iframe-wrapper">
            <iframe id="iframe1" src="http://localhost:5173/home"></iframe>
        </div>
        <div class="iframe-wrapper">
            <iframe id="iframe2" src="http://localhost:5173/about"></iframe>
        </div>
    </div>

    <div class="parent-log">
        <h3>父页面接收日志：</h3>
        <div id="parentLog"></div>
    </div>

    <div class="parent-log" style="border-color: #e91e63; margin-top: 15px;">
        <h3 style="color: #e91e63;">MessageChannel 通信日志：</h3>
        <div id="channelLog"></div>
    </div>

    <script>
        const iframe1 = document.getElementById('iframe1');
        const iframe2 = document.getElementById('iframe2');
        const parentLog = document.getElementById('parentLog');
        const channelLog = document.getElementById('channelLog');

        // MessageChannel 相关变量
        let homeChannel = null;
        let aboutChannel = null;
        let homePort = null;
        let aboutPort = null;

        // 初始化 MessageChannel
        function initMessageChannels() {
            // 为 Home iframe 创建 MessageChannel
            homeChannel = new MessageChannel();
            console.log('打印***homeChannel', homeChannel)
            homePort = homeChannel.port1;

            homePort.onmessage = function (event) {
                console.log('父页面通过MessageChannel收到Home消息:', event.data);
                addChannelLog('Home → 父页面', event.data.message || JSON.stringify(event.data));

                // 可以转发给 About
                if (aboutPort && event.data.forwardToAbout) {
                    aboutPort.postMessage({
                        from: 'Home (通过父页面转发)',
                        message: event.data.message
                    });
                }
            };

            // 为 About iframe 创建 MessageChannel
            aboutChannel = new MessageChannel();
            aboutPort = aboutChannel.port1;
            console.log('打印***aboutPort', aboutChannel, homeChannel)

            aboutPort.onmessage = function (event) {
                console.log('父页面通过MessageChannel收到About消息:', event.data);
                addChannelLog('About → 父页面', event.data.message || JSON.stringify(event.data));

                // 可以转发给 Home
                if (homePort && event.data.forwardToHome) {
                    homePort.postMessage({
                        from: 'About (通过父页面转发)',
                        message: event.data.message
                    });
                }
            };

            console.log('MessageChannels 已初始化');
        }
        let count = 0
        setInterval(() => {
            count++;
            window.name = count
        }, 5000)

        // 监听来自 iframe 的消息
        window.addEventListener('message', function (event) {
            console.log('父页面收到消息:', event.data);

            // 处理 MessageChannel 初始化请求
            if (event.data.type === 'MESSAGE_CHANNEL_READY') {
                console.log('接收到MessageChannel初始化请求:', event.data.from);

                if (event.data.from === 'Home') {
                    // 通知 Home iframe MessageChannel 已准备好
                    iframe1.contentWindow.postMessage({
                        type: 'MESSAGE_CHANNEL_READY',
                        from: 'Parent',
                        action: 'ready'
                    }, '*', [homeChannel.port2]);
                    addChannelLog('初始化', 'Home MessageChannel 已建立');
                } else if (event.data.from === 'About') {
                    // 通知 About iframe MessageChannel 已准备好
                    iframe2.contentWindow.postMessage({
                        type: 'MESSAGE_CHANNEL_READY',
                        from: 'Parent',
                        action: 'ready'
                    }, '*', [aboutChannel.port2]);
                    addChannelLog('初始化', 'About MessageChannel 已建立');
                }
                return;
            }

            // 处理 sessionStorage 更新通知
            if (event.data.type === 'SESSION_STORAGE_UPDATE') {
                console.log('父页面转发 sessionStorage 更新通知');

                // 记录到日志
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <small>${new Date().toLocaleTimeString()}</small><br>
                    <strong>来自:</strong> ${event.data.from || '未知'}<br>
                    <strong>类型:</strong> sessionStorage 更新<br>
                    <strong>键:</strong> ${event.data.key}<br>
                    <strong>值:</strong> ${event.data.value}
                `;
                parentLog.appendChild(logItem);
                parentLog.scrollTop = parentLog.scrollHeight;

                // 广播给所有 iframe（除了发送者）
                iframe1.contentWindow.postMessage(event.data, '*');
                iframe2.contentWindow.postMessage(event.data, '*');
                return;
            }

            // 记录普通消息到父页面日志
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small><br>
                <strong>来自:</strong> ${event.data.from || '未知'}<br>
                <strong>目标:</strong> ${event.data.target || '未知'}<br>
                <strong>消息:</strong> ${event.data.message || JSON.stringify(event.data)}
            `;
            parentLog.appendChild(logItem);
            parentLog.scrollTop = parentLog.scrollHeight;

            // 根据目标转发消息
            if (event.data.target === 'iframe1') {
                iframe1.contentWindow.postMessage(event.data, '*');
            } else if (event.data.target === 'iframe2') {
                iframe2.contentWindow.postMessage(event.data, '*');
            } else if (event.data.target === 'parent') {
                // 父页面处理消息
                console.log('父页面处理消息:', event.data.message);
            }
        });

        // 父页面发送消息到 iframe1
        function sendMessageToIframe1() {
            const input = document.getElementById('parentMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            iframe1.contentWindow.postMessage({
                from: 'Parent (父页面)',
                message: message
            }, '*');

            input.value = '';
            console.log('父页面发送消息到 Iframe 1:', message);
        }

        // 父页面发送消息到 iframe2
        function sendMessageToIframe2() {
            const input = document.getElementById('parentMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            iframe2.contentWindow.postMessage({
                from: 'Parent (父页面)',
                message: message
            }, '*');

            input.value = '';
            console.log('父页面发送消息到 Iframe 2:', message);
        }

        // 父页面广播消息到所有 iframe
        function sendMessageToAll() {
            const input = document.getElementById('parentMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            const messageData = {
                from: 'Parent (父页面 - 广播)',
                message: message
            };

            iframe1.contentWindow.postMessage(messageData, '*');
            iframe2.contentWindow.postMessage(messageData, '*');

            input.value = '';
            console.log('父页面广播消息到所有 Iframe:', message);
        }

        // 支持回车键发送
        document.getElementById('parentMessageInput').addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                sendMessageToAll();
            }
        });

        // 可选：供控制台使用的函数
        function sendToIframe1(message) {
            iframe1.contentWindow.postMessage({
                from: 'parent',
                message: message
            }, '*');
        }

        function sendToIframe2(message) {
            iframe2.contentWindow.postMessage({
                from: 'parent',
                message: message
            }, '*');
        }

        // 添加 MessageChannel 通信日志
        function addChannelLog(from, message) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small><br>
                <strong>类型:</strong> MessageChannel<br>
                <strong>来自:</strong> ${from}<br>
                <strong>消息:</strong> ${message}
            `;
            channelLog.appendChild(logItem);
            channelLog.scrollTop = channelLog.scrollHeight;
        }

        // MessageChannel 通信函数
        function sendChannelToIframe1() {
            const input = document.getElementById('channelMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            if (homePort) {
                homePort.postMessage({
                    from: 'Parent (MessageChannel)',
                    message: message
                });
                addChannelLog('父页面 → Home', message);
            } else {
                alert('Home MessageChannel 未初始化');
            }

            input.value = '';
        }

        function sendChannelToIframe2() {
            const input = document.getElementById('channelMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            if (aboutPort) {
                aboutPort.postMessage({
                    from: 'Parent (MessageChannel)',
                    message: message
                });
                addChannelLog('父页面 → About', message);
            } else {
                alert('About MessageChannel 未初始化');
            }

            input.value = '';
        }

        function sendChannelToAll() {
            const input = document.getElementById('channelMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            const messageData = {
                from: 'Parent (MessageChannel - 广播)',
                message: message
            };

            if (homePort) {
                homePort.postMessage(messageData);
            }
            if (aboutPort) {
                aboutPort.postMessage(messageData);
            }

            if (homePort || aboutPort) {
                addChannelLog('父页面 → 所有', message);
            } else {
                alert('MessageChannels 未初始化');
            }

            input.value = '';
        }

        // 兄弟通信函数（通过父页面中转）
        function sendBrotherFrom1To2() {
            const input = document.getElementById('brotherMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            // 通过 postMessage 发送到 iframe2
            iframe2.contentWindow.postMessage({
                from: 'Home (通过父页面)',
                message: message,
                type: 'BROTHER_COMMUNICATION'
            }, '*');

            // 记录到普通日志
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small><br>
                <strong>类型:</strong> 兄弟通信<br>
                <strong>发送:</strong> Home → About<br>
                <strong>消息:</strong> ${message}
            `;
            parentLog.appendChild(logItem);
            parentLog.scrollTop = parentLog.scrollHeight;

            input.value = '';
        }

        function sendBrotherFrom2To1() {
            const input = document.getElementById('brotherMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('请输入消息');
                return;
            }

            // 通过 postMessage 发送到 iframe1
            iframe1.contentWindow.postMessage({
                from: 'About (通过父页面)',
                message: message,
                type: 'BROTHER_COMMUNICATION'
            }, '*');

            // 记录到普通日志
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small><br>
                <strong>类型:</strong> 兄弟通信<br>
                <strong>发送:</strong> About → Home<br>
                <strong>消息:</strong> ${message}
            `;
            parentLog.appendChild(logItem);
            parentLog.scrollTop = parentLog.scrollHeight;

            input.value = '';
        }

        // 页面加载时初始化 MessageChannel
        window.addEventListener('load', function () {
            initMessageChannels();
        });

        // 支持回车键发送
        document.getElementById('channelMessageInput').addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                sendChannelToAll();
            }
        });

        document.getElementById('brotherMessageInput').addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                sendBrotherFrom1To2();
            }
        });

        window.sendToIframe1 = sendToIframe1;
        window.sendToIframe2 = sendToIframe2;

        console.log('提示: 可以在控制台使用 sendToIframe1("消息") 或 sendToIframe2("消息") 从父页面发送消息');
        console.log('MessageChannel 通信功能已加载');
    </script>
</body>

</html>