<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>é¡µé¢A - Service Worker é€šä¿¡</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        h3 {
            color: #2196F3;
        }

        input {
            padding: 10px;
            width: 300px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #1976D2;
        }

        #log {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        #log p {
            margin: 5px 0;
            padding: 5px;
            background-color: white;
            border-left: 3px solid #2196F3;
            border-radius: 2px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }

        .status.active {
            background-color: #4CAF50;
            color: white;
        }

        .status.inactive {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>

<body>
    <h3>é¡µé¢ Aï¼ˆæ ‡è¯†ï¼špage-123ï¼‰</h3>

    <div id="status" class="status inactive">Service Worker æœªæ¿€æ´»</div>

    <div>
        <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯">
        <br>
        <button onclick="sendBroadcast()">å¹¿æ’­æ¶ˆæ¯</button>
        <button onclick="sendToPageB()">å‘ç»™é¡µé¢B</button>
        <button onclick="getOnlineList()">è·å–åœ¨çº¿åˆ—è¡¨</button>
    </div>

    <div id="log"></div>

    <script>
        // é¡µé¢å”¯ä¸€æ ‡è¯†
        const pageId = 'page-123';
        let serviceWorkerReady = false;

        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<p>[${time}] ${message}</p>`;
            log.scrollTop = log.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(active) {
            const statusEl = document.getElementById('status');
            if (active) {
                statusEl.textContent = 'Service Worker å·²æ¿€æ´»';
                statusEl.className = 'status active';
                serviceWorkerReady = true;
            } else {
                statusEl.textContent = 'Service Worker æœªæ¿€æ´»';
                statusEl.className = 'status inactive';
                serviceWorkerReady = false;
            }
        }

        // æ³¨å†Œ Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
                    addLog('Service Worker æ³¨å†ŒæˆåŠŸ');

                    // ç­‰å¾… Service Worker æ¿€æ´»
                    await navigator.serviceWorker.ready;
                    updateStatus(true);
                    addLog('Service Worker å·²æ¿€æ´»');

                    // å‘é€æ³¨å†Œæ¶ˆæ¯
                    navigator.serviceWorker.controller.postMessage({
                        type: 'register',
                        pageId: pageId
                    });

                } catch (error) {
                    console.error('Service Worker æ³¨å†Œå¤±è´¥:', error);
                    addLog('Service Worker æ³¨å†Œå¤±è´¥: ' + error.message);
                }
            } else {
                addLog('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
            }
        }

        // ç›‘å¬æ¥è‡ª Service Worker çš„æ¶ˆæ¯
        navigator.serviceWorker.addEventListener('message', (event) => {
            console.log('é¡µé¢Aæ”¶åˆ°æ¶ˆæ¯:', event.data);

            const { type, from, sender, data } = event.data;

            if (type === 'registered') {
                addLog(`âœ“ ${data}`);
            } else if (type === 'broadcast') {
                addLog(`ğŸ“¢ ${sender ? 'æ¥è‡ª ' + sender + ': ' : ''}${data}`);
            } else if (type === 'private') {
                addLog(`ğŸ“¨ ${sender ? 'æ¥è‡ª ' + sender + ': ' : ''}${data}`);
            } else if (type === 'online-list') {
                addLog(`ğŸ‘¥ åœ¨çº¿åˆ—è¡¨: [${data.join(', ')}]`);
            } else {
                addLog(`æ”¶åˆ°ï¼š${JSON.stringify(event.data)}`);
            }
        });

        // å‘é€å¹¿æ’­æ¶ˆæ¯
        function sendBroadcast() {
            if (!serviceWorkerReady) {
                addLog('âš  Service Worker æœªå°±ç»ª');
                return;
            }

            const input = document.getElementById('msgInput');
            if (!input.value.trim()) {
                addLog('âš  è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            navigator.serviceWorker.controller.postMessage({
                type: 'broadcast',
                pageId: pageId,
                data: input.value
            });

            addLog(`ğŸ“¤ å‘é€å¹¿æ’­: ${input.value}`);
            input.value = '';
        }

        // å‘é€ç‚¹å¯¹ç‚¹æ¶ˆæ¯ç»™é¡µé¢B
        function sendToPageB() {
            if (!serviceWorkerReady) {
                addLog('âš  Service Worker æœªå°±ç»ª');
                return;
            }

            const input = document.getElementById('msgInput');
            if (!input.value.trim()) {
                addLog('âš  è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            navigator.serviceWorker.controller.postMessage({
                type: 'private',
                pageId: pageId,
                target: 'page-456',
                data: input.value
            });

            addLog(`ğŸ“¤ å‘é€ç§ä¿¡ç»™ page-456: ${input.value}`);
            input.value = '';
        }

        // è·å–åœ¨çº¿åˆ—è¡¨
        function getOnlineList() {
            if (!serviceWorkerReady) {
                addLog('âš  Service Worker æœªå°±ç»ª');
                return;
            }

            navigator.serviceWorker.controller.postMessage({
                type: 'get-online',
                pageId: pageId
            });
        }

        // é¡µé¢å…³é—­æ—¶å‘é€æ–­å¼€è¿æ¥æ¶ˆæ¯
        window.addEventListener('beforeunload', () => {
            if (serviceWorkerReady && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'disconnect',
                    pageId: pageId
                });
            }
        });

        // åˆå§‹åŒ–
        registerServiceWorker();

        // å®šæœŸå‘é€å¿ƒè·³ï¼ˆå¯é€‰ï¼Œç”¨äºæ£€æµ‹è¿æ¥çŠ¶æ€ï¼‰
        setInterval(() => {
            if (serviceWorkerReady && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'heartbeat',
                    pageId: pageId
                });
            }
        }, 10000);
    </script>
</body>

</html>
